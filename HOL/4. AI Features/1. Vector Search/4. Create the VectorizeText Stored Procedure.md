# Step 4: Create the VectorizeText Stored Procedure

Now, we will create a **stored procedure** that calls **Azure OpenAI** to generate **vector embeddings**.

## Why Do We Need This?

AI models transform text into **vectors** that store semantic meaning. We need a stored procedure to:

- **Send text** (movie titles and user queries) to Azure OpenAI.
- **Receive a vector** representation of the text.
- **Store the vector** in our SQL database.

## Create the Stored Procedure

Run the following T-SQL script:

```sql
CREATE OR ALTER PROCEDURE VectorizeText
    @Text varchar(max),
    @Vector vector(1536) OUTPUT
AS
BEGIN
    -- Define Azure OpenAI endpoint
    DECLARE @OpenAIEndpoint varchar(max) = 'https://lenni-m6wi7gcd-eastus2.cognitiveservices.azure.com/'
    DECLARE @OpenAIDeploymentName varchar(max) = 'text-embedding-3-large'
    DECLARE @OpenAIVersion varchar(max) = '2023-05-15'
    DECLARE @Url varchar(max) = CONCAT(@OpenAIEndpoint, 'openai/deployments/', @OpenAIDeploymentName, '/embeddings?api-version=', @OpenAIVersion)

    -- API key (Replace with your valid key)
    DECLARE @OpenAIApiKey varchar(max) = '1l01K92g5ObpFKmgMVs8RJ8XC3IY6bNTGtj0ECyQqRV0CztW8Qu4JQQJ99BBACHYHv6XJ3w3AAAAACOGrnno'
    DECLARE @Headers varchar(max) = JSON_OBJECT('api-key': @OpenAIApiKey)

    -- Payload: requests 1536-dimensional vectors instead of 3072
    DECLARE @Payload varchar(max) = JSON_OBJECT('input': @Text, 'dimensions': 1536)

    -- Prepare response variable
    DECLARE @Response nvarchar(max)
    DECLARE @ReturnValue int

    -- Call Azure OpenAI to get vector representation
    EXEC @ReturnValue = sp_invoke_external_rest_endpoint
        @url = @Url,
        @method = 'POST',
        @headers = @Headers,
        @payload = @Payload,
        @response = @Response OUTPUT

    -- Print raw JSON response for debugging
    PRINT @Response

    -- Handle API errors
    IF @ReturnValue != 0
        THROW 50000, @Response, 1

    -- Extract vector from JSON response
    DECLARE @VectorJson nvarchar(max) = JSON_QUERY(@Response, '$.result.data[0].embedding')

    -- Convert JSON vector to SQL Server's vector type
    SET @Vector = CONVERT(vector(1536), @VectorJson)
END
```

### How it Works

This stored procedure accepts any text, and uses ``sp_invoke_external_rest_endpoint`` to call Azure OpenAI. It passes in the text, receives a vector back from Azure OpenAI, and is returned from the stored procedure via an output parameter declared as the `vector(1536)` data type.

- Note that `sp_invoke_external_rest_endpoint` is available today in Azure SQL Database, but is not available in SQL Server 2022. However, it will be available in SQL Server 2025.

Observe how the call is constructed from these components:

1. The URL starts with an endpoint to the Azure OpenAI model deployment, which can be copied and pasted in from the Azure portal. For this lab, the endpoint is `https://lenni-m6wi7gcd-eastus2.cognitiveservices.azure.com/`.
1. The URL continues with the text `openai/deployments/`, and then followed by the
name of the Azure OpenAI text embedding model that has been deployed in advance of this lab, which is `text-embedding-3-large`. This is a deeply trained text embedding model, available via Azure OpenAI.
1. The URL terminates with `/embeddings`, and a query string parameter that specifies the version of the OpenAI API that the request should use.
1. The HTTP method used to call Azure OpenAI is a `POST`.
1. The HTTP headers supply the model's API key. **This should always be kept secret,** since call consumption will be **billed** to the associated Azure subscription. You can and should also enable a **network firewall** around your Azure resource that blocks access to all but authorized
clients.
    - **Note**: For this lab, you are using the provided API key to access an Azure OpenAI resource with no firewall. The API key is temporary, and will be deleted after the lab is concluded.
1. The payload supplies the actual text to be vectorized, which is passed in to the stored procedure as the `@Text` parameter. It also specifies `dimensions` to request that Azure OpenAI return a compressed version (1536 dimensions) of the vector returned by the `text-embedding-3-large` model (which provides 3072 dimensions), in order to accommodate the current (preview) SQL Server vector size limit of 1998 dimensions.

### Processing the Result

The stored procedure handles the Azure OpenAI result as follows:

1. If the API call fails, the it throws an error.
1. If the API call succeeds, the vector is retrieved from the JSON response. Specifically, it is extracted from the `embedding` property of the first element in the `data` array of the `result` property
in the response. This simple demo is only vectorizing one piece of text per API call, but you can also vectorize **multiple** pieces of text in a **single** API call. In that case, you could retrieve the vector returned for each piece of text from each element returned by the `result.data` array in the response.
1. Finally, the raw JSON vector response is converted to a native `vector` data type in SQL Server, sized at 1536 dimensions (to match the number of dimensions returned, per vector, by the text-embedding-3-large
model, after being compressed from 3072 dimensions down to 1536). This value is returned in the stored procedure's `@Vector` output parameter.

### Test the Stored Procedure

Now run the stored procedure to vectorize any arbitrary piece of text:

```sql
DECLARE @Vector vector(1536)
EXEC VectorizeText 'Vectorize this text', @Vector OUTPUT
SELECT @Vector
```

If everything is working properly, you should see the first several floating point values in the vector array returned by Azure OpenAI (note that these values are expressed using scientific notation).

Now check the **Messages tab** to see the raw JSON response generated by the `PRINT` statement.

Notice how the first few values in the JSON response match the first few values in SQL Server’s **vector(1536)** column.

While these numbers aren't human readable, they describe a pattern that captures the semantic meaning of the vectorized text, based on the deeply trained text embedding model in Azure OpenAI.

___

▶ [Step 5: Vectorize the Database](https://github.com/lennilobel/sql2022-workshop-hol-vegas2025/blob/master/HOL/4.%20AI%20Features/1.%20Vector%20Search/5.%20Vectorize%20the%20Database.md)
