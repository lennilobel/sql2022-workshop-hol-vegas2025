# Step 6 - Create the VectorSearch Stored Procedure

Now, we will create a **stored procedure** that finds the **most similar movie** based on a **natural language query**.

Traditional SQL searches rely on **exact text matching**, but **vector search** allows us to:

- Find movies **based on meaning**, not just words.  
- Handle **typos and variations** in queries.  
- Perform **AI-powered recommendations**.

## How the Stored Procedure Works

The stored procedure runs a vector search  as follows:

1. **Vectorizes** the user's question using `VectorizeText`.
2. **Finds the most similar movie** using `VECTOR_DISTANCE('cosine', query_vector, movie_vector)`.
3. **Returns the closest match**.

## Create the Stored Procedure

Run the following SQL to create the `VectorSearch` stored procedure:

```sql
CREATE OR ALTER PROCEDURE VectorSearch
    @Question varchar(max)
AS
BEGIN
    -- Prepare a vector variable to capture the question vector components
    DECLARE @QuestionVector vector(1536)

    -- Vectorize the question using Azure OpenAI
    EXEC VectorizeText @Question, @QuestionVector OUTPUT

    -- Find the most similar movie based on cosine similarity
    SELECT TOP 1 
        Title, 
        VECTOR_DISTANCE('cosine', @QuestionVector, Vector) AS CosineDistance
    FROM Movie
    ORDER BY CosineDistance
END
```

## Test the Stored Procedure

Run:

```sql
EXEC VectorSearch 'May the force be with you';
EXEC VectorSearch 'I''m gonna make him an offer he can''t refuse';
```

✅ The most **semantically similar** movie will be returned!

___

▶ [Step 7: Run AI Queries](https://github.com/lennilobel/sql2022-workshop-hol-vegas2025/blob/master/HOL/4.%20AI%20Features/1.%20Vector%20Search/7.%20Run%20AI%20Queries.md)
