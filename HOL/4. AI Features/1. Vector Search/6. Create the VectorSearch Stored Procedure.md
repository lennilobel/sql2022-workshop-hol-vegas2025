# Step 6: Create the VectorSearch Stored Procedure

Now, we will create a **stored procedure** that finds the **most similar movie** based on a **natural language query**.

Traditional SQL searches rely on **exact text matching**, but **vector search** allows us to:

- Find movies **based on meaning**, not just words.  
- Handle **typos and variations** in queries.  
- Perform **AI-powered recommendations**.

## Create the Stored Procedure

Run the following SQL to create the `VectorSearch` stored procedure:

```sql
CREATE OR ALTER PROCEDURE VectorSearch
    @Question varchar(max)
AS
BEGIN
    -- Prepare a vector variable to capture the question vector components
    DECLARE @QuestionVector vector(1536)

    -- Vectorize the question using Azure OpenAI
    EXEC VectorizeText @Question, @QuestionVector OUTPUT

    -- Find the most similar movie based on cosine similarity
    SELECT TOP 1 
        Question = @Question,
        Title, 
        VECTOR_DISTANCE('cosine', @QuestionVector, Vector) AS CosineDistance
    FROM Movie
    ORDER BY CosineDistance
END
```

## How it Works

This stored procedure accepts a natural language query in the `@Question` parameter, and calls the `VectorizeText` stored procedure to vectorize the question (this is the same one we used to vectorize titles in the `Movie` table). It then uses the new T-SQL `VECTOR_DISTANCE` function to retrieve the movie title that most similarly matches the question. Using `TOP 1` with `ORDER BY` on the calculated distance returns the most similar result, where the least distant is the most similar. This is based on the semantic meaning embedded in the movie database vectors and the user's query vector.

- Note that `VECTOR_DISTANCE_` is available today in Azure SQL Database, but is not available in SQL Server 2022. However, it will be available in SQL Server 2025.

The stored procedure works as follows:

1. **Vectorizes** the user's question using `VectorizeText`.
2. **Finds the most similar movie** using `VECTOR_DISTANCE('cosine', query_vector, movie_vector)`.
3. **Returns the closest match**.

Observe that the `VECTOR_DISTANCE` function's first parameter accepts a "metric" property, which we are setting
as `cosine`. This means that we are calculating the **cosine distance** between the user's question and every movie in the database.

  - Note that cosine is the most commonly used distance metric, although others (including Dot Product and Euclidean) are also supported for specialized use cases.

___

â–¶ [Step 7: Run AI Queries](https://github.com/lennilobel/sql2022-workshop-hol-vegas2025/blob/master/HOL/4.%20AI%20Features/1.%20Vector%20Search/7.%20Run%20AI%20Queries.md)
