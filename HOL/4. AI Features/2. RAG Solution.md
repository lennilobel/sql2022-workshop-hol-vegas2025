# RAG Solution

In this lab...

```sql
DROP TABLE IF EXISTS Tag
DROP TABLE IF EXISTS MealType
DROP TABLE IF EXISTS Instruction
DROP TABLE IF EXISTS Ingredient
DROP TABLE IF EXISTS Recipe

IF EXISTS (SELECT * FROM sys.database_scoped_credentials WHERE name = 'BlobStorageCredential')
    DROP DATABASE SCOPED CREDENTIAL BlobStorageCredential

IF EXISTS (SELECT * FROM sys.external_data_sources WHERE name = 'BlobStorageContainer')
    DROP EXTERNAL DATA SOURCE BlobStorageContainer

IF EXISTS (SELECT * FROM sys.symmetric_keys WHERE name = '##MS_DatabaseMasterKey##')
	DROP MASTER KEY
```

```sql
CREATE TABLE Recipe(
	RecipeId int NOT NULL,
	RecipeName varchar(50) NOT NULL,
	PrepTimeMinutes int,
	CookTimeMinutes int,
	Servings int,
	Difficulty varchar(50),
	Cuisine varchar(50),
	CaloriesPerService int,
	Rating decimal(18, 9),
	ReviewCount int,
	CONSTRAINT PK_Recipe PRIMARY KEY CLUSTERED (RecipeId),
)

CREATE TABLE Ingredient(
	IngredientId int NOT NULL IDENTITY,
	RecipeId int NOT NULL,
	IngredientIndex int NOT NULL,
	IngredientName varchar(50) NOT NULL,
	CONSTRAINT PK_Ingredient PRIMARY KEY CLUSTERED  (IngredientId),
	CONSTRAINT FK_Recipe_Ingredient FOREIGN KEY(RecipeId) REFERENCES Recipe (RecipeId),
)

CREATE TABLE Instruction(
	InstructionId int NOT NULL IDENTITY,
	RecipeId int NOT NULL,
	InstructionIndex int NOT NULL,
	InstructionText varchar(200) NOT NULL,
	CONSTRAINT PK_Instruction PRIMARY KEY CLUSTERED (InstructionId),
	CONSTRAINT FK_Recipe_Instruction FOREIGN KEY(RecipeId) REFERENCES Recipe (RecipeId),
)

CREATE TABLE MealType(
	MealTypeId int NOT NULL IDENTITY,
	RecipeId int NOT NULL,
	MealTypeName varchar(50) NOT NULL,
	CONSTRAINT PK_MealType PRIMARY KEY CLUSTERED (MealTypeId),
	CONSTRAINT FK_Recipe_MealType FOREIGN KEY(RecipeId) REFERENCES Recipe (RecipeId),
)

CREATE TABLE Tag(
	TagId int IDENTITY(1,1) NOT NULL,
	RecipeId int NOT NULL,
	TagName varchar(50) NOT NULL,
	CONSTRAINT PK_Tag PRIMARY KEY CLUSTERED (TagId),
	CONSTRAINT FK_Recipe_Tag FOREIGN KEY(RecipeId) REFERENCES Recipe (RecipeId),
)
```

```sql
CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'Str0ngP@$$w0rd'

CREATE DATABASE SCOPED CREDENTIAL BlobStorageCredential
	WITH IDENTITY = 'SHARED ACCESS SIGNATURE',	-- SAS token for Blob, Object, Read access (expires 8/13/2026)
	SECRET = 'sv=2022-11-02&ss=b&srt=o&sp=r&se=2026-08-13T20:00:58Z&st=2024-08-13T12:00:58Z&spr=https&sig=1u6aOJE%2B1pwRDB8r5nKMEylcNgUl77jiIeaDkWKIOVA%3D'

CREATE EXTERNAL DATA SOURCE BlobStorageContainer
WITH (
	TYPE = BLOB_STORAGE,
	LOCATION = 'https://lennidemo.blob.core.windows.net/datasets',
	CREDENTIAL = BlobStorageCredential
)
```

```sql
-- Delete data from child tables
DELETE FROM Ingredient
DELETE FROM Instruction
DELETE FROM MealType
DELETE FROM Tag

-- Delete data from the Recipe table
DELETE FROM Recipe
```

```sql
-- Retrieve the raw JSON source file from blob storage
DECLARE @Json varchar(max) = (
	SELECT BulkColumn
	FROM OPENROWSET(BULK 'Recipes.json', DATA_SOURCE = 'BlobStorageContainer', SINGLE_CLOB) AS RecipesJson
)

-- Insert into the Recipe table
INSERT INTO Recipe (RecipeId, RecipeName, PrepTimeMinutes, CookTimeMinutes, Servings, Difficulty, Cuisine, CaloriesPerService, Rating, ReviewCount)
SELECT 
    JSON_VALUE(Recipe.value, '$.id') AS RecipeId,
    JSON_VALUE(Recipe.value, '$.name') AS RecipeName,
    JSON_VALUE(Recipe.value, '$.prepTimeMinutes') AS PrepTimeMinutes,
    JSON_VALUE(Recipe.value, '$.cookTimeMinutes') AS CookTimeMinutes,
    JSON_VALUE(Recipe.value, '$.servings') AS Servings,
    JSON_VALUE(Recipe.value, '$.difficulty') AS Difficulty,
    JSON_VALUE(Recipe.value, '$.cuisine') AS Cuisine,
    JSON_VALUE(Recipe.value, '$.caloriesPerServing') AS CaloriesPerService,
    JSON_VALUE(Recipe.value, '$.rating') AS Rating,
    JSON_VALUE(Recipe.value, '$.reviewCount') AS ReviewCount
FROM OPENJSON(@Json) AS Recipe

-- Insert into the Ingredient table
INSERT INTO Ingredient (RecipeId, IngredientIndex, IngredientName)
SELECT 
    JSON_VALUE(Recipe.value, '$.id') AS RecipeId,
    Ingredient.[key] AS IngredientIndex,
    Ingredient.value AS IngredientName
FROM OPENJSON(@Json) AS Recipe
CROSS APPLY OPENJSON(Recipe.value, '$.ingredients') AS Ingredient

-- Insert into the Instruction table
INSERT INTO Instruction (RecipeId, InstructionIndex, InstructionText)
SELECT 
    JSON_VALUE(Recipe.value, '$.id') AS RecipeId,
    Instruction.[key] AS InstructionIndex,
    Instruction.value AS InstructionText
FROM OPENJSON(@Json) AS Recipe
CROSS APPLY OPENJSON(Recipe.value, '$.instructions') AS Instruction

-- Insert into the MealType table
INSERT INTO MealType (RecipeId, MealTypeName)
SELECT 
    JSON_VALUE(Recipe.value, '$.id') AS RecipeId,
    MealType.value AS MealTypeName
FROM OPENJSON(@Json) AS Recipe
CROSS APPLY OPENJSON(Recipe.value, '$.mealType') AS MealType

-- Insert into the Tag table
INSERT INTO Tag (RecipeId, TagName)
SELECT 
    JSON_VALUE(Recipe.value, '$.id') AS RecipeId,
    Tag.value AS TagName
FROM OPENJSON(@Json) AS Recipe
CROSS APPLY OPENJSON(Recipe.value, '$.tags') AS Tag
```

```sql
SELECT * FROM Recipe
SELECT * FROM Ingredient
SELECT * FROM Instruction
SELECT * FROM MealType
SELECT * FROM Tag
```

```sql
SELECT 
    r.RecipeId,
    r.RecipeName,
    r.PrepTimeMinutes,
    r.CookTimeMinutes,
    r.Servings,
    r.Difficulty,
    r.Cuisine,
    r.CaloriesPerService,
    r.Rating,
    r.ReviewCount,
    Ingredients = (
        SELECT STRING_AGG(CONCAT(i.RowNum, ') ', i.IngredientName), '. ')
        FROM (
            SELECT 
                IngredientName,
                ROW_NUMBER() OVER (ORDER BY IngredientId) AS RowNum
            FROM Ingredient
            WHERE RecipeId = r.RecipeId
        ) AS i
    ),
    Instructions = (
        SELECT STRING_AGG(CONCAT(i.RowNum, ') ', i.InstructionText), ' ')
        FROM (
            SELECT 
                InstructionText,
                ROW_NUMBER() OVER (ORDER BY InstructionId) AS RowNum
            FROM Instruction
            WHERE RecipeId = r.RecipeId
        ) AS i
    ),
    MealType = (
        SELECT STRING_AGG(mt.MealTypeName, '; ')
        FROM MealType AS mt
        WHERE mt.RecipeId = r.RecipeId
    ),
    Tags = (
        SELECT STRING_AGG(t.TagName, '; ')
        FROM Tag AS t
        WHERE t.RecipeId = r.RecipeId
    )
FROM Recipe AS r
FOR JSON AUTO
```